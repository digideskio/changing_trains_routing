<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" lang="en"></meta>
  <title>Umsteigematrix im Bahnhof</title>
  <script src="http://openlayers.org/api/2.13.1/OpenLayers.js"></script> 
  <script src="http://overpass-api.de/OpenStreetMap.js"></script>
  <script src="draw_latlon_markers.js"></script>
  <script type="text/javascript">
  
  function init()
  {
    DrawLatLonMarkers.init_map(52, 10, 8);
    //DrawLatLonMarkers.draw_trace([{lat: 50.8, lon: 7.1}, {lat: 51.2, lon: 7.2}, {lat: 52, lon: 7.5}]);
  }

  
  function closure_show_trace(trace, station)
  {
    var trace_ = trace;
    var station_ = station;
        
    function handler(event)
    {
      DrawLatLonMarkers.clear_map();
      for (var i = 0; i < station.gates.length; ++i)
      {
        if (station.gates[i].lat && station.gates[i].lon)
          DrawLatLonMarkers.draw_point(station.gates[i].lat, station.gates[i].lon);
      }
      DrawLatLonMarkers.draw_trace(trace_);
    }
       
    return handler;
  }

  
  function closure_show_tree(gate, station)
  {
    var gate_ = gate;
    var station_ = station;
        
    function handler(event)
    {
      DrawLatLonMarkers.clear_map();
      for (var i = 0; i < station.gates.length; ++i)
      {
        if (station.gates[i].lat && station.gates[i].lon)
          DrawLatLonMarkers.draw_point(station.gates[i].lat, station.gates[i].lon);
      }
      if (gate_.connections)
      {
        for (var j = 0; j < gate_.connections.length; ++j)
        {
          if (gate_.connections[j].trace)
            DrawLatLonMarkers.draw_trace(gate_.connections[j].trace);
        }
      }
    }
       
    return handler;
  }
  
  
  function show_station(station)
  {
    if (!station)
    {
      alert("Internal error: station data is empty.");
      return;
    }
      
    var text_area = document.getElementById("textual_results");
    if (!text_area)
    {
      alert("Internal error: no target for text output found.");
      return;
    }
    
    DrawLatLonMarkers.clear_map();
    while (text_area.hasChildNodes())
      text_area.removeChild(text_area.lastChild);
    
    var xml_node = document.createElement("h2");
    if (station.name)
      xml_node.appendChild(document.createTextNode(station.name));
    text_area.appendChild(xml_node);
    
    if (!station.gates)
    {
      alert("Internal error: station has no gate data.");
      return;
    }
    
    for (var i = 0; i < station.gates.length; ++i)
    {
      var gate = station.gates[i];
      
      var xml_node = document.createElement("a");
      xml_node.setAttribute("href", "#");
      if (gate && gate.ref)
        xml_node.appendChild(document.createTextNode(gate.ref));
      xml_node.addEventListener("click",
      {
        handleEvent: closure_show_tree(gate, station)
      }, false);
      text_area.appendChild(xml_node);
      text_area.appendChild(document.createElement("br"));
      
      if (gate.connections)
      {
        for (var j = 0; j < gate.connections.length; ++j)
        {
          text_area.appendChild(document.createTextNode(" -> "));
          
          var xml_node = document.createElement("a");
          xml_node.setAttribute("href", "#");
          if (gate.connections[j] && gate.connections[j].to)
            xml_node.appendChild(document.createTextNode(gate.connections[j].to));
          if (gate.connections[j].trace)
          {
            xml_node.addEventListener("click",
            {
              handleEvent: closure_show_trace(gate.connections[j].trace, station)
            }, false);
          }
          text_area.appendChild(xml_node);
          
          if (gate.connections[j].cost)
          {
            if (gate.connections[j].cost == 180.0)
              text_area.appendChild(document.createTextNode(": not connected"));
            else
              text_area.appendChild(document.createTextNode(": " + Math.round(gate.connections[j].cost * 111111.111)));
          }
          
          text_area.appendChild(document.createElement("br"));   
        }
      }
      
      if (gate.lat && gate.lon)
        DrawLatLonMarkers.draw_point(gate.lat, gate.lon);
    }
    DrawLatLonMarkers.adjust_map();
  }
    
  function load_data()
  {
    var station_name = "";
    var station_name_field = document.getElementById("station_name");
    if (station_name_field && station_name_field.value)
      station_name = station_name_field.value;
    
    function xhreqCallback()
    {
      if (this.readyState == 4)
      {
        if (this.status == 200)
          show_station(JSON.parse(this.responseText));
        else
          alert(this.statusText);
      }          
    }
          
    var xhreq = new XMLHttpRequest();
    if (xhreq == null)
        alert("Browser not supported (the browser doesn't have XMLHttpRequest). "
            + "Please use instead e.g. a recent Firefox version.");
    
    xhreq.open("GET", "/adam/api/matrix?name=" + station_name, true);
    xhreq.onreadystatechange = xhreqCallback;
    xhreq.send(null);    
  }

  </script>
</head>
<body onload="init()">

<div style="position:absolute; top:0%; left:0%; height:100%; width:30%; z-index:1">
    <div style="height:20%">
        <form action="#" acceptCharset="UTF-8">
            <input type="text" id="station_name" value=""></input>
            <input type="submit" value="Fetch data" onclick="load_data()"></input>
        </form>  
        <strong id="status">&nbsp;</strong>
    </div>
    <div id="textual_results" style="height:90%; overflow-y:scroll"></div>
</div>
<div id="map" class="smallmap" style="position:absolute; top:0%; left:30%; height:100%; width:70%; z-index:1"></div>

</body>
</html>
