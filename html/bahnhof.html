<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" lang="en"></meta>
  <title>Umsteigematrix im Bahnhof</title>
  <script src="http://openlayers.org/api/2.13.1/OpenLayers.js"></script> 
  <script src="http://overpass-api.de/OpenStreetMap.js"></script>
  <script src="draw_latlon_markers.js"></script>
  <script type="text/javascript">
  
  function init()
  {
    DrawLatLonMarkers.init_map(51.5, 10, 6);
    //DrawLatLonMarkers.draw_trace([{lat: 50.8, lon: 7.1}, {lat: 51.2, lon: 7.2}, {lat: 52, lon: 7.5}]);
  }
  
  
  function draw_background_features(station)
  {
    DrawLatLonMarkers.clear_map();
    
    if (station.elevators)
    {
      for (var i = 0; i < station.elevators.length; ++i)
      {
        if (station.elevators[i].lat && station.elevators[i].lon)
          DrawLatLonMarkers.draw_point(station.elevators[i].lat, station.elevators[i].lon, "black");
      }
    }
    
    if (station.expected_elevators)
    {
      for (var i = 0; i < station.expected_elevators.length; ++i)
      {
        if (station.expected_elevators[i].lat && station.expected_elevators[i].lon)
          DrawLatLonMarkers.draw_point(station.expected_elevators[i].lat, station.expected_elevators[i].lon,
              "purple");
      }
    }
    
    if (station.gates)
    {
      for (var i = 0; i < station.gates.length; ++i)
      {
        if (station.gates[i].lat && station.gates[i].lon)
          DrawLatLonMarkers.draw_point(station.gates[i].lat, station.gates[i].lon, "blue");
      }
    }
  }

  
  function closure_show_trace(trace, station)
  {
    var trace_ = trace;
    var station_ = station;
        
    function handler(event)
    {
      draw_background_features(station);
      DrawLatLonMarkers.draw_trace(trace_);
      DrawLatLonMarkers.adjust_map();
    }
       
    return handler;
  }

  
  function closure_show_tree(gate, station)
  {
    var gate_ = gate;
    var station_ = station;
        
    function handler(event)
    {
      draw_background_features(station);
      if (gate_.connections)
      {
        for (var j = 0; j < gate_.connections.length; ++j)
        {
          if (gate_.connections[j].trace)
            DrawLatLonMarkers.draw_trace(gate_.connections[j].trace);
        }
      }
      DrawLatLonMarkers.adjust_map();
    }
       
    return handler;
  }
  
  
  function show_station(station)
  {
    if (!station)
    {
      alert("Internal error: station data is empty.");
      return;
    }
      
    if (station.error)
    {
      alert(station.error);
      return;
    }
      
    var text_area = document.getElementById("textual_results");
    if (!text_area)
    {
      alert("Internal error: no target for text output found.");
      return;
    }
    
    while (text_area.hasChildNodes())
      text_area.removeChild(text_area.lastChild);
    
    var xml_node = document.createElement("h2");
    if (station.name)
      xml_node.appendChild(document.createTextNode(station.name));
    text_area.appendChild(xml_node);
    if (station.gates)
      text_area.appendChild(document.createTextNode("with " + station.gates.length + " elevators in OSM"));
    text_area.appendChild(document.createElement("br"));
    
    if (station.expected_elevators)
    {
      for (var i = 0; i < station.expected_elevators.length; ++i)
      {
        if (station.expected_elevators[i].ref)
        {
          if (station.expected_elevators[i].lat && station.expected_elevators[i].lon)
            text_area.appendChild(document.createTextNode("elevator " + station.expected_elevators[i].ref));
          else if (station.expected_elevators[i].status)
            text_area.appendChild(document.createTextNode("elevator " + station.expected_elevators[i].ref
                + ": " + station.expected_elevators[i].status));
          text_area.appendChild(document.createElement("br"));
        }
      }
    }
    
    if (!station.gates)
    {
      alert("Internal error: station has no gate data.");
      return;
    }
    
    for (var i = 0; i < station.gates.length; ++i)
    {
      var gate = station.gates[i];
      
      text_area.appendChild(document.createElement("br"));
      var xml_node = document.createElement("a");
      xml_node.setAttribute("href", "#");
      if (gate && gate.ref)
        xml_node.appendChild(document.createTextNode(gate.ref));
      xml_node.addEventListener("click",
      {
        handleEvent: closure_show_tree(gate, station)
      }, false);
      text_area.appendChild(xml_node);
      text_area.appendChild(document.createElement("br"));
      
      if (gate.connections)
      {
        for (var j = 0; j < gate.connections.length; ++j)
        {
          text_area.appendChild(document.createTextNode(" -> "));
          
          var xml_node = document.createElement("a");
          xml_node.setAttribute("href", "#");
          if (gate.connections[j] && gate.connections[j].to)
            xml_node.appendChild(document.createTextNode(gate.connections[j].to));
          if (gate.connections[j].trace)
          {
            xml_node.addEventListener("click",
            {
              handleEvent: closure_show_trace(gate.connections[j].trace, station)
            }, false);
          }
          text_area.appendChild(xml_node);
          
          if (gate.connections[j].cost)
          {
            if (gate.connections[j].trace.length == 0)
              text_area.appendChild(document.createTextNode(": not connected"));
            else
              text_area.appendChild(document.createTextNode(": " + Math.round(gate.connections[j].cost * 10) / 10));
          }
          
          text_area.appendChild(document.createElement("br"));   
        }
      }
    }
    draw_background_features(station);
    DrawLatLonMarkers.adjust_map();
  }
    
  function load_data()
  {
    var station_name = "";
    var station_name_field = document.getElementById("station_name");
    if (station_name_field && station_name_field.value)
      station_name = station_name_field.value;
    
    var profile = "";
    var profile_field = document.getElementById("profile");
    if (profile_field && profile_field.value)
      profile = profile_field.value;
    
    function xhreqCallback()
    {
      if (this.readyState == 4)
      {
        if (this.status == 200)
          show_station(JSON.parse(this.responseText));
        else
          alert(this.statusText);
      }          
    }
          
    var xhreq = new XMLHttpRequest();
    if (xhreq == null)
        alert("Browser not supported (the browser doesn't have XMLHttpRequest). "
            + "Please use instead e.g. a recent Firefox version.");
    
    xhreq.open("GET", "/adam/api/matrix_w?name=" + station_name + "&profile=" + profile, true);
    xhreq.onreadystatechange = xhreqCallback;
    xhreq.send(null);
  }

  </script>
</head>
<body onload="init()">

<div style="position:absolute; top:0%; left:0%; height:100%; width:30%; z-index:1">
  <div style="height:20%">
    <form action="#" acceptCharset="UTF-8">
      <input type="text" id="station_name" value=""></input>
      <select id="profile" value="distance">
        <option>distance</option>
        <option>sport</option>
        <option>luggage</option>
        <option>wheelchair</option>
      </select>
      <input type="submit" value="Fetch data" onclick="load_data()"></input>
    </form>  
    <strong id="status">&nbsp;</strong>
  </div>
  <div id="textual_results" style="height:80%; overflow-y:scroll"></div>
</div>
<div id="map" class="smallmap" style="position:absolute; top:0%; left:30%; height:100%; width:70%; z-index:1"></div>

</body>
</html>
